{% set now = "now"|date("Y-m-t", "America/Bogota") %}
{% set yearAgo = "now"|date_modify("-11 months")|date("Y-m-01", "America/Bogota") %}

{% set monthNow = "now"|date("m", "America/Bogota") %}
{% set monthAgo = "now"|date_modify("-0 months")|date("Y-m-01", "America/Bogota") %}

{% set info=enviar_post_ws('getCantidadTomadaDiariamenteSnt','fechaInicial='~monthAgo~'&fechaFinal='~now~'&codigoTipoDemanda=0',1,1,'','','cantidad_mbtud')  %}

<link rel="stylesheet" type="text/css"
      href="https://cdn.datatables.net/v/dt/jqc-1.12.4/jszip-3.1.3/pdfmake-0.1.27/dt-1.10.15/af-2.2.0/b-1.3.1/b-colvis-1.3.1/b-flash-1.3.1/b-html5-1.3.1/b-print-1.3.1/cr-1.3.3/fc-3.2.2/fh-3.1.2/kt-2.2.1/r-2.1.1/rg-1.0.0/rr-1.2.0/sc-1.4.2/se-1.2.2/datatables.min.css"/>
<script type="text/javascript"
        src="https://cdn.datatables.net/v/dt/jqc-1.12.4/jszip-3.1.3/pdfmake-0.1.27/dt-1.10.15/af-2.2.0/b-1.3.1/b-colvis-1.3.1/b-flash-1.3.1/b-html5-1.3.1/b-print-1.3.1/cr-1.3.3/fc-3.2.2/fh-3.1.2/kt-2.2.1/r-2.1.1/rg-1.0.0/rr-1.2.0/sc-1.4.2/se-1.2.2/datatables.min.js"></script>

<link rel="stylesheet" type="text/css"
      href="http://www.bmcbec.com.co/App_Plugins/BECCharts/front-end/datePicker/css/datepicker.css">
<script type="text/javascript"
        src="http://www.bmcbec.com.co/App_Plugins/BECCharts/front-end/datePicker/js/bootstrap-datepicker.js"></script>
{{ attach_library('bmcbec/tables') }}
{{ attach_library('bmcbec/chartJS') }}

<div class="filter-graphic" align="center">
    <div class="bmcbec-dp-left">
        <form method="post" action="">
            <input type="submit" name="quickDate" value="1m" class="bmcbec-dp-button"/>
            <input type="submit" name="quickDate" value="3m" class="bmcbec-dp-button"/>
            <input type="submit" name="quickDate" value="6m" class="bmcbec-dp-button"/>
            <input type="submit" name="quickDate" value="1a" class="bmcbec-dp-button"/>
        </form>
        <p class="helpText">Consulta rápidamente desde un mes (1m) hasta un año (1a)</p>
    </div>
    <div class="bmcbec-dp-right">
    <form method="post" action="">
    <input type="text" class="span2" value="{{ monthAgo }}" id="dpd1" name="paramsFilter[fechaInicial]" data-date="{{ monthAgo }}" data-date-format="yyyy-mm-dd" data-date-viewmode="years" data-date-minviewmode="days">
    <input type="text" class="span2" value="{{ now }}" id="dpd2" name="paramsFilter[fechaFinal]" data-date="{{ now }}" data-date-format="yyyy-mm-dd" data-date-viewmode="years" data-date-minviewmode="days">
    
    <select name="paramsFilter[codigoTipoDemanda]">
    <option value="0" selected="">-- Todos Tipos de Demanda --</option>
    <optgroup label="Seleccione un Tipo de Demanda">
        <option value="2">NO REGULADO</option>
        <option value="1">REGULADO</option>
    </optgroup>
    </select>
    <input type="submit" value="Consultar" class="bmcbec-dp-button">
    </form>
    <p class="helpText">Consulta un periodo hasta 395 días</p></div>
    <div class="bmcbec-dp-fix"></div>
</div>

<div class="bmcbec-fix"></div>

{{ include('resultados_info.html.twig', {"info": info}) }}

<div class="canvas-holder" >
<canvas id="canvas" ></canvas>
</div>
<style type="text/css">
    .chart-container {
  position: relative;
  margin: auto;
  height: 80vh;
  width: 80vw;
}
</style><script type="text/javascript">

{% if info['paramsFilter'] is not null %}
var codigoTipoDemanda = {{ (info['paramsFilter']['codigoTipoDemanda'])?:0 }};
$("option[value=" + codigoTipoDemanda + "]").attr('selected', 'selected');

var fechaInicial = '{{ info['paramsFilter']['fechaInicial'] }}';
$("input[id='dpd1']").attr('value', fechaInicial);

var fechaFinal = '{{ info['paramsFilter']['fechaFinal'] }}';
$("input[id='dpd2']").attr('value', fechaFinal);

{% endif %}

var randomColor = function(opacity) {
    return 'rgba(' + Math.round(Math.random() * 255) + ',' + Math.round(Math.random() * 255) + ',' + Math.round(Math.random() * 255) + ',' + (opacity || '.3') + ')';
};

var lineChartData = {
        labels: [
            {% for key, item in info["dataGraficas"] %}
            "{{ key }}",
            {% endfor %}
        ],
    datasets: [
         {
         label: "Cantidad (MBTUD)",
         data: [
             {% for item in info["dataGraficas"] %}
             "{{item}}",
             {% endfor %}
         ]
         },

    ]
    };
  
    $.each(lineChartData.datasets, function(i, dataset) {
        dataset.borderColor = randomColor(0.4);
        dataset.backgroundColor = randomColor(1);
        dataset.pointBorderColor = randomColor(0.7);
        dataset.pointBackgroundColor = randomColor(0.5);
        dataset.pointBorderWidth = 1;
    });

    window.onload = function() {
        var ctx = document.getElementById("canvas");
        window.myLine = Chart.Line(ctx, {
            data: lineChartData,
            options: {
                responsive: true,
                hoverMode: 'label',
                stacked: false,
                title:{
                    display:false,
                    text:'CANTIDAD DE ENERGÍA TOMADA DIARIAMENTE POR EL SNT',
                    fontSize: 16,
                },
                legend: {
                    position: (/Android|webOS|iPhone|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) ? 'bottom' : 'top'
                },
                scales: {
                    xAxes: [{
                        display: true,
                        gridLines: {
                            offsetGridLines: false
                        },
                        ticks: {
                             userCallback: function(dataLabel, index) {
                                 return index % 2 === 0 ? dataLabel : '';
                             }
                        }
                    }],
                    yAxes: [{
                        type: "linear",
                        display: true,
                        position: "left",
                        id: "y-axis-1",
                    }, /*{
                        type: "linear",
                        display: true,
                        position: "right",
                        id: "y-axis-2",
                    }*/
                    ],
                }
            }
        });
    };

    $('#randomizeData').click(function() {
        lineChartData.datasets[0].data = [randomScalingFactor(), randomScalingFactor(), randomScalingFactor(), randomScalingFactor(), randomScalingFactor(), randomScalingFactor(), randomScalingFactor()];

        lineChartData.datasets[1].data = [randomScalingFactor(), randomScalingFactor(), randomScalingFactor(), randomScalingFactor(), randomScalingFactor(), randomScalingFactor(), randomScalingFactor()];

        window.myLine.update();
    });

    var c=document.getElementById("canvas");
    var ctx=c.getContext("3d");
    ctx.font="30px Arial";

    </script>

<!-- END OF GRAPHIC CONSTRUCTOR -->
<div class="bmcbec-fix"></div>

<!-- TABLE CONSTRUCTOR -->
<div class="table-holder">
    <h4>Tabla de Resultados</h4>
    <p class="alert alert-warning">Utilice las opciones de filtrado y ordenamiento para refinar los datos mostrados en la tabla.</p>
    <table id="ResultTable" class="display" cellspacing="0" width="100%">
        <thead>
        <tr>
            <th>Año</th>
            <th>Mes</th>
            <th>Día</th>
            <th>Modalidad</th>
            <th>Tipo de demanda</th>
            <th>Sector de consumo</th>
            <th>Cantidad (MBTUD)</th>
        </tr>
        </thead>
        <tfoot>
        <tr>
            <th>Año</th>
            <th>Mes</th>
            <th>Día</th>
            <th>Modalidad</th>
            <th>Tipo de demanda</th>
            <th>Sector de consumo</th>
            <th>Cantidad (MBTUD)</th>
        </tr>
        </tfoot>
        <tbody>
        {% for key, data in info["dataTables"] %}
            <tr valign="top" align="left">
                <td>{{ data.ano }}</td>
                <td>{{ data.mes }}</td>
                <td>{{ data.dia }}</td>
                <td>{{ data.desc_modalidad }}</td>
                <td>{{ data.tipo_demanda }}</td>
                <td>{{ data.sector_consumo }}</td>
                <td align="right" data-order="{{ data.cantidad_mbtud }}">{{ data.cantidad_mbtud }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<!-- Begin - Export Option Table -->
<div id="table2export">
<table id="ResultTable1"></table>
</div>
<!-- END - Export Option Table -->

<script type="text/javascript">
    $(document).ready(function() {
        $("#ResultTable thead").clone().appendTo("#ResultTable1");
        $("#ResultTable tfoot").clone().appendTo("#ResultTable1");
        $("#ResultTable tbody").clone().appendTo("#ResultTable1");
        dataTablesIni();
        datesFieldsValidation(395, 395);
    });
</script>

<!-- END OF TABLE CONSTRUCTOR -->

<script type="text/javascript">
//     $('form').submit(function () {
//         return checkDateRange($('#dpd1').val(), $('#dpd2').val(), 395, 395);
//     });
//     $(document).ready(function() {
//         insertText(395);
//     });
</script>