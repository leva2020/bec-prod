{% set now = "now"|date("Y-m-t", "America/Bogota") %}
{% set monthAgo = "now"|date_modify("-1 months")|date("Y-m-01", "America/Bogota") %}

{% set info = enviar_post_ws('getComportamientoOperativoMercado', 'fechaInicial=' ~monthAgo~ '&fechaFinal=' ~now~ '&codigoReporte=1',1,1,'','','cantidad')  %}

{#<link rel="stylesheet" type="text/css" href="https://datatables.net/media/css/site.css">#}
{#<link rel="stylesheet" type="text/css" href="http://www.bmcbec.com.co/App_Plugins/BECCharts/front-end/datePicker/css/bootstrap.css">#}
<link rel="stylesheet" type="text/css"
      href="https://cdn.datatables.net/v/dt/jqc-1.12.4/jszip-3.1.3/pdfmake-0.1.27/dt-1.10.15/af-2.2.0/b-1.3.1/b-colvis-1.3.1/b-flash-1.3.1/b-html5-1.3.1/b-print-1.3.1/cr-1.3.3/fc-3.2.2/fh-3.1.2/kt-2.2.1/r-2.1.1/rg-1.0.0/rr-1.2.0/sc-1.4.2/se-1.2.2/datatables.min.css"/>
<script type="text/javascript"
        src="https://cdn.datatables.net/v/dt/jqc-1.12.4/jszip-3.1.3/pdfmake-0.1.27/dt-1.10.15/af-2.2.0/b-1.3.1/b-colvis-1.3.1/b-flash-1.3.1/b-html5-1.3.1/b-print-1.3.1/cr-1.3.3/fc-3.2.2/fh-3.1.2/kt-2.2.1/r-2.1.1/rg-1.0.0/rr-1.2.0/sc-1.4.2/se-1.2.2/datatables.min.js"></script>
<link rel="stylesheet" type="text/css"
      href="http://www.bmcbec.com.co/App_Plugins/BECCharts/front-end/datePicker/css/datepicker.css">
<script type="text/javascript"
        src="http://www.bmcbec.com.co/App_Plugins/BECCharts/front-end/datePicker/js/bootstrap-datepicker.js"></script>

{{ attach_library('bmcbec/tables') }}
{{ attach_library('bmcbec/chartJS') }}

<div class="well" align="center">
    <div class="bmcbec-dp-left">
        <form method="post" action="">
            <input type="submit" name="quickDate" value="1m" class="bmcbec-dp-button"/>
            <input type="submit" name="quickDate" value="3m" class="bmcbec-dp-button"/>
            <input type="submit" name="quickDate" value="6m" class="bmcbec-dp-button"/>
            <input type="submit" name="quickDate" value="1a" class="bmcbec-dp-button"/>
        </form>
        <p class="helpText">Consulta rápidamente desde un mes (1m) hasta un año (1a)</p>
    </div>
    <div class="bmcbec-dp-right">
        <form method="post" action="">
            <input type="text" class="span2" value="{{ monthAgo }}" id="dpd1" name="paramsFilter[fechaInicial]" data-date="{{ monthAgo }}" data-date-format="yyyy-mm-dd" data-date-viewmode="months" data-date-minviewmode="days" style="width: 100px;" />
            <input type="text" class="span2" value="{{ now }}" id="dpd2" name="paramsFilter[fechaFinal]" data-date="{{ now }}" data-date-format="yyyy-mm-dd" data-date-viewmode="months" data-date-minviewmode="days" style="width: 100px;" />
            <select name="paramsFilter[codigoReporte]" style="width: 200px;">
                <option value="1" selected>-- Selecciona una opción --</option>
                <option value="2" >Cantidad Energ&#237;a a Suministrar</option>
                <option value="3" >Cantidad Energ&#237;a Declarada por Comercializador</option>
                <option value="1"  selected >Cantidad Energ&#237;a Inyectada</option>
                <option value="4" >Cantidad Energ&#237;a Tomada correspondiente a Contratos de Parqueo</option>
                <option value="7" >Cantidad Energ&#237;a Tomada por Comercializadores</option>
                <option value="6" >Cantidad Energ&#237;a Tomada por Transportadores por Tramo</option>
                <option value="5" >Cantidades Totales Energ&#237;a Autorizada Diariamente de acuerdo Nominaciones</option>
            </select>
            <input type="submit" value="Consultar" class="bmcbec-dp-button" style="margin-top:20px;" />
        </form>
        <p class="helpText">Consulta un periodo hasta 365 días</p>
    </div>
    <div class="bmcbec-dp-fix"></div>
</div>

<script type="text/javascript">
    datesFieldsValidation(365);
</script>
<div class="bmcbec-fix"></div>

<!-- GRAPHIC CONSTRUCTOR -->
<!-- <script type="text/javascript" src="~/App_Plugins/BECCharts/front-end/jquery.min.js"></script> -->
<script type="text/javascript" src="/App_Plugins/BECCharts/front-end/Chart.js-master/dist/Chart.bundle.js"></script>
<style>
    canvas {
        -moz-user-select: none;
        -webkit-user-select: none;
        -ms-user-select: none;
    }
</style>
<div class="canvas-holder1">
    <h3 align="center">COMPORTAMIENTO OPERATIVO DEL MERCADO</h3>
    <canvas id="chart" />
</div>
<script type="text/javascript">
    var randomScalingFactor = function() {
        return Math.round(Math.random() * 100 * (Math.random() > 0.5 ? -1 : 1));
    };
    var randomColor = function(opacity) {
        return 'rgba(' + Math.round(Math.random() * 255) + ',' + Math.round(Math.random() * 255) + ',' + Math.round(Math.random() * 255) + ',' + (opacity || '.3') + ')';
    };
    var config = {
        type: 'line',
        data: {
            labels: {{ info["labels"]|json_encode|raw }},
            datasets: [
                {% for key, dataSet in info["dataDataSets"] %}
                {
                    label: "{{ key }}",
                    data: {{ dataSet|json_encode|raw }}
                },
                {% endfor %}
            ]
        },
        options: {
            responsive: true,
            legend: {
                position: 'bottom',
            },
            title:{
                display:false,
                text:'COMPORTAMIENTO OPERATIVO DEL MERCADO',
                fontSize: 16,
            },
            tooltips: {
                mode: 'label',
            },
            hover: {
                mode: 'dataset'
            },
            scales: {
                xAxes: [{
                    display: true,
                    scaleLabel: {
                        show: true,
                        labelString: 'Mes'
                    }
                }],
                yAxes: [{
                    display: true,
                    scaleLabel: {
                        show: true,
                        labelString: 'Valor'
                    },
                    ticks: {
                        suggestedMin: 0,
                        //suggestedMax: 250,
                    }
                }]
            }
        }
    };

    $.each(config.data.datasets, function(i, dataset) {
        var tempColor = randomColor(1);
        dataset.borderColor = tempColor;
        dataset.backgroundColor = tempColor;
        dataset.pointBorderColor = tempColor;
        dataset.pointBackgroundColor = tempColor;
        dataset.borderWidth = 5;
        dataset.pointBorderWidth = 0;
        dataset.pointHoverRadius = 0;
        dataset.pointHoverBorderWidth = 0;
        dataset.pointRadius = 0;
        dataset.pointHitRadius = 0;
    });

    window.onload = function() {
        var ctx = document.getElementById("chart").getContext("2d");
        window.myLine = new Chart(ctx, config);
    };

    //Oculta el formulario de consulta
    if(location.search == "?showform=1"){
        $('.form').hide();
    }
</script>

<script type="text/javascript" src="/App_Plugins/BECCharts/front-end/_bmcbec-js-validation.js"></script>
<script type="text/javascript">
    {% if info['paramsFilter'] is not null %}
        var fechaInicial = '{{ info['paramsFilter']['fechaInicial'] }}';
        $("input[id='dpd1']").attr('value', fechaInicial);

        var fechaFinal = '{{ info['paramsFilter']['fechaFinal'] }}';
        $("input[id='dpd2']").attr('value', fechaFinal);
    {% endif %}
    $(document).ready(function() {
        datesFieldsValidation(395, 395);
    });
</script>

<style>
    section p {
        font-size: 1em;
    }
</style>
